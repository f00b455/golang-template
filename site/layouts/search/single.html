{{ define "title" }}Search - {{ .Site.Title }}{{ end }}

{{ define "main" }}
<h1>Search</h1>

<form id="search-form">
    <input type="text" id="search-input" placeholder="Enter search term..." autofocus>
    <button type="submit">Search</button>
    <button type="button" onclick="clearSearch()">Clear</button>
</form>

<div id="search-results">
    <p>Enter a search term above to search through stories.</p>
</div>

{{ end }}

{{ define "scripts" }}
<script>
// Simple search functionality
(function() {
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-input');
    const resultsContainer = document.getElementById('search-results');

    // HTML escape function to prevent XSS
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Build search index from page data
    const searchIndex = [
        {{ range where .Site.RegularPages "Section" "stories" }}
        {
            title: {{ .Title | jsonify }},
            url: {{ .Permalink | jsonify }},
            content: {{ .Plain | jsonify }},
            date: {{ .Date.Format "2006-01-02" | jsonify }}
        },
        {{ end }}
    ];

    function performSearch(query) {
        if (!query) {
            resultsContainer.innerHTML = '<p>Enter a search term above to search through stories.</p>';
            return;
        }

        const lowerQuery = query.toLowerCase();
        const results = searchIndex.filter(item => {
            return item.title.toLowerCase().includes(lowerQuery) ||
                   item.content.toLowerCase().includes(lowerQuery);
        });

        if (results.length === 0) {
            resultsContainer.innerHTML = '<p>No results found for: <strong>' + escapeHtml(query) + '</strong></p>';
        } else {
            let html = '<p>Found ' + escapeHtml(results.length) + ' result(s) for: <strong>' + escapeHtml(query) + '</strong></p>';
            html += '<ul>';
            results.forEach(item => {
                html += '<li>';
                // URLs are already safe from Hugo's jsonify, but escape for safety
                html += '<a href="' + escapeHtml(item.url) + '">' + escapeHtml(item.title) + '</a>';
                html += ' - ' + escapeHtml(item.date);

                // Show snippet with highlighted search term
                const contentSnippet = getSnippet(item.content, query);
                if (contentSnippet) {
                    html += '<br><small>' + contentSnippet + '</small>';
                }
                html += '</li>';
            });
            html += '</ul>';
            resultsContainer.innerHTML = html;
        }
    }

    function getSnippet(content, query) {
        const index = content.toLowerCase().indexOf(query.toLowerCase());
        if (index === -1) return '';

        const start = Math.max(0, index - 50);
        const end = Math.min(content.length, index + query.length + 50);
        let snippet = content.substring(start, end);

        // Escape HTML first to prevent XSS
        snippet = escapeHtml(snippet);

        if (start > 0) snippet = '...' + snippet;
        if (end < content.length) snippet = snippet + '...';

        // Highlight the search term safely after escaping
        // Create a safe regex pattern by escaping special regex characters
        const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(safeQuery, 'gi');
        snippet = snippet.replace(regex, '<strong>$&</strong>');

        return snippet;
    }

    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        performSearch(searchInput.value.trim());
    });

    window.clearSearch = function() {
        searchInput.value = '';
        resultsContainer.innerHTML = '<p>Enter a search term above to search through stories.</p>';
        searchInput.focus();
    };
})();
</script>
{{ end }}