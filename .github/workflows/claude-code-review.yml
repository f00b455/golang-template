name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

run-name: "Claude Code Review #${{ github.event.pull_request.number }}"
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Need write to comment
      issues: read
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check Iteration Count
        id: iteration
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Get iteration from labels
          ITERATION=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name' | grep -oP 'pipeline:iteration-\K\d+' || echo "0")

          if [[ -z "$ITERATION" ]]; then
            ITERATION=0
          fi

          echo "ITERATION=$ITERATION" >> $GITHUB_OUTPUT
          echo "Reviewing PR #$PR_NUMBER (iteration: $ITERATION)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            IMPORTANT CONTEXT:
            - This is iteration ${{ steps.iteration.outputs.ITERATION }} of the review process
            - If this is iteration 2 or higher, focus on whether previous issues were addressed
            - Be progressively more lenient with each iteration - avoid nitpicking on later iterations
            - After 3 iterations, only flag critical issues (bugs, security problems)

            Use the repository's CLAUDE.md for guidance on style and conventions. Be constructive and helpful in your feedback.

            At the end of your review, clearly state one of:
            - "âœ… APPROVED - No major issues found" if the code is ready
            - "ðŸ”§ CHANGES REQUESTED - Issues found that need fixing" if there are problems

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.
          
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/sdk#command-line for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

