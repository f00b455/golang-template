name: Claude Code Improvements

on:
  workflow_run:
    workflows: ["Claude Code Review"]
    types:
      - completed

jobs:
  improve-code:
    runs-on: ubuntu-latest
    # Only run after Claude Code Review completes successfully
    if: github.event.workflow_run.conclusion == 'success'

    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Get PR number from workflow name
        id: pr
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          echo "Workflow name: $WORKFLOW_NAME"

          # Extract PR number from workflow name pattern: "Title #123"
          PR_NUMBER=$(echo "$WORKFLOW_NAME" | grep -oE '#[0-9]+' | grep -oE '[0-9]+' | head -1)

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No PR number found in workflow name: $WORKFLOW_NAME"
            exit 1
          fi

          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Found PR #$PR_NUMBER from workflow name"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Fetch PR branch
        run: |
          gh pr checkout ${{ steps.pr.outputs.PR_NUMBER }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post automation status comment
        run: |
          gh pr comment ${{ steps.pr.outputs.PR_NUMBER }} --body "ðŸ¤– **Claude Code Automation Running**

          The automated improvements workflow is actively implementing review feedback.

          **Status**: ðŸ”„ In Progress
          **Workflow**: [View Live Progress](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **Started**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          This comment will be updated when the automation completes.

          ---
          *ðŸ¤– Automated by Claude Code Pipeline*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Code to implement review feedback
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Read the latest code review on PR #${{ steps.pr.outputs.PR_NUMBER }} and implement the requested changes.

            Steps:
            1. Read the review: gh pr view ${{ steps.pr.outputs.PR_NUMBER }} --json comments --jq '.comments[] | select(.author.login == "claude") | .body' | tail -1
            2. If the review says "Request Changes", implement ALL the issues mentioned
            3. Test your changes: make test
            4. Commit: git add -A && git commit -m "improve: implement code review feedback" && git push

          claude_args: '--allowed-tools "Read,Edit,Write,MultiEdit,Bash(gh pr view:*),Bash(make:*),Bash(git:*),Bash(go:*)"'