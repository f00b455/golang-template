name: Claude Code Improvements

on:
  workflow_run:
    workflows: ["Claude Code Review"]
    types:
      - completed

jobs:
  improve-code:
    runs-on: ubuntu-latest
    # Only run after Claude Code Review completes successfully
    if: github.event.workflow_run.conclusion == 'success'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Get PR number
        id: pr
        run: |
          # Extract PR number from workflow name (format: "Claude Code Review #123")
          WORKFLOW_NAME="${{ github.event.workflow_run.display_title }}"
          echo "Workflow display title: $WORKFLOW_NAME"

          # Extract PR number from workflow name using regex
          if [[ "$WORKFLOW_NAME" =~ \#([0-9]+) ]]; then
            PR_NUMBER="${BASH_REMATCH[1]}"
          else
            echo "Could not extract PR number from workflow name: $WORKFLOW_NAME"
            echo "Falling back to SHA-based lookup"
            SHA="${{ github.event.workflow_run.head_sha }}"
            PR_NUMBER=$(gh api repos/${{ github.repository }}/commits/$SHA/pulls --jq '[0].number' 2>/dev/null || echo "")
          fi

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No PR number found in workflow name or SHA lookup"
            exit 1
          fi

          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Found PR #$PR_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Fetch PR branch
        run: |
          gh pr checkout ${{ steps.pr.outputs.PR_NUMBER }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Code to implement review feedback
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Read the latest code review on PR #${{ steps.pr.outputs.PR_NUMBER }} and implement the requested changes.

            Steps:
            1. Read the review: gh pr view ${{ steps.pr.outputs.PR_NUMBER }} --json comments --jq '.comments[] | select(.author.login == "claude") | .body' | tail -1
            2. If the review says "Request Changes", implement ALL the issues mentioned
            3. Test your changes: make test
            4. Commit: git add -A && git commit -m "improve: implement code review feedback" && git push

          claude_args: '--allowed-tools "Read,Edit,Write,MultiEdit,Bash(gh pr view:*),Bash(make:*),Bash(git:*),Bash(go:*)"'